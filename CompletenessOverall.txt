// limi running: 
#DECLARE delayDate int = 1;
#DECLARE logStartDate string = DateTime.Today.AddDays(-60-@delayDate).ToUniversalTime().Date.ToString("yyyy-MM-dd");
#DECLARE logEndDate string = DateTime.Today.AddDays(-1-@delayDate).ToUniversalTime().Date.ToString("yyyy-MM-dd");

#DECLARE adsCompletenessOverall string = String.Format("/shares/ffo.prod/local/Auditing/E2E/ADS/SharePoint/%Y-%m-%d/completenessOverall.txt?date={0}...{1}&sparsestreamset=true", @logStartDate, @logEndDate);
#DECLARE nrtCompletenessOverall string = String.Format("/shares/ffo.prod/local/Auditing/E2E/NRT/SharePoint/%Y-%m-%d/completenessOverall.txt?date={0}...{1}&sparsestreamset=true", @logStartDate, @logEndDate);
#DECLARE pumperCompletenessOverall string = String.Format("/shares/ffo.prod/local/Auditing/E2E/PUMPER/SharePoint/%Y-%m-%d/completenessOverall.txt?date={0}...{1}&sparsestreamset=true", @logStartDate, @logEndDate);
#DECLARE datefile string = @"/shares/ffo.prod/local/Aggregated/Auditing/Resources/date60.txt";

IdRange = EXTRACT
  Id : int
  FROM @datefile
  USING DefaultTextExtractor();
  
DateRange = SELECT
  DateTime.Today.AddDays(Id-@delayDate).ToUniversalTime().Date.ToString("yyyy-MM-dd") AS Date
  FROM IdRange;
  
PumperCompletenessOverall = EXTRACT
  Date : string,
  RawCount : long,
  AuditCount : long,
  Ratio : double
  FROM @pumperCompletenessOverall
  USING DefaultTextExtractor();
 
NrtCompletenessOverall = EXTRACT
  Date : string,
  RawCount : long,
  AuditCount : long,
  Ratio : double
  FROM @nrtCompletenessOverall
  USING DefaultTextExtractor();
  
AdsCompletenessOverall = EXTRACT
  Date : string,
  RawCount : long,
  AuditCount : long,
  Ratio : double
  FROM @adsCompletenessOverall
  USING DefaultTextExtractor();

fullJoin =
    SELECT DateRange.Date AS Date,
           NrtCompletenessOverall.RawCount AS RawCount,
           NrtCompletenessOverall.AuditCount AS NrtAuditCount,
           NrtCompletenessOverall.Ratio AS NrtRawRatio
    FROM   DateRange
    LEFT OUTER JOIN NrtCompletenessOverall
    ON     DateRange.Date == NrtCompletenessOverall.Date;

fullJoin =
    SELECT fullJoin.*,
           AdsCompletenessOverall.AuditCount AS AdsAuditCount,
           AdsCompletenessOverall.Ratio AS AdsRawRatio
    FROM    fullJoin
    LEFT OUTER JOIN AdsCompletenessOverall
    ON     fullJoin.Date == AdsCompletenessOverall.Date;
    
fullJoin =
    SELECT fullJoin.*,
           PumperCompletenessOverall.AuditCount AS PumperAuditCount,
           PumperCompletenessOverall.Ratio AS PumperRawRatio
    FROM    fullJoin
    LEFT OUTER JOIN PumperCompletenessOverall
    ON     fullJoin.Date == PumperCompletenessOverall.Date;
    
fullJoin =
    SELECT TOP 60 fullJoin.*,
           NrtRawRatio AS NrtRatio,
           (((AdsAuditCount == null) || (NrtAuditCount == null) || (NrtAuditCount == 0)) ? 0 : (AdsAuditCount * 1.0 / NrtAuditCount)) AS AdsRatio,
           (((PumperAuditCount == null) || (AdsAuditCount == null) || (AdsAuditCount == 0)) ? 0 : (PumperAuditCount * 1.0 / AdsAuditCount)) AS PumperRatio
    FROM    fullJoin
    ORDER BY Date ASC;
